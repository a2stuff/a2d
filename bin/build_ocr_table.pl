#!/usr/bin/env perl

# Process a font file (in text format) into a Lua hash table for doing
# basic OCR on the screen. Used in tests/lib/a2dtest.lua

# Usage:
#  bin/build_ocr_table.pl < res/fonts/System.unicode.txt > tests/lib/ocr_table.lua
#
# Homoglyphs (pixel-identical glyphs) produce a warning (to stderr)
# and only the first is recorded. This primarily affects non-Latin
# scripts and some punctuation. Fortunately, with the current system
# font, '0' and 'O' are not homoglyphs.

use strict;
use warnings;

binmode(STDERR, ":utf8");

# Parse font file header
$_ = <STDIN>; chomp;
die "expected type, saw '$_'" unless m/^type: (\d+)$/;
my $type = $1;
die "bad type: $type" unless ($type == 0) || ($type == 128);
my $max_width = ($type == 0) ? 7 : 14;
$_ = <STDIN>; chomp;
die "expected height, saw '$_'" unless m/^height: (\d+)$/;
my $height = $1;

# Emit Lua file header
print <<"EOF";
--[[
  Generated by bin/build_ocr_table.pl - DO NOT EDIT
]]

ocr_table = { height = $height, width = $max_width }
EOF

my %table = ();

# Process one character at a time
while (<STDIN>) {
  # Get character identifier
  chomp;
  die "expected char banner, saw '$_'" unless m/^== U\+([0-9A-F]{4,}) ==$/;
  my $char = $1;

  # Read in bitmap lines
  my @lines = ();
  my $width;
  for (my $line = 0; $line < $height; ++$line) {
    $_ = <STDIN>;
    chomp;
    if ($line == 0) {
      $width = length($_);
      die "bad width" if $width > $max_width;
    } else {
      die "bad width" unless length($_) == $width;
    }
    $lines[$line] = $_;
  }

  # Skip control characters (which we use as symbols)
  next if hex($char) < 0x20;

  # Convert from row-oriented to column-oriented
  my @cols = ();
  for (my $col = 0; $col < $width; ++$col) {
    $cols[$col] = '';
  }
  for (my $col = 0; $col < $width; ++$col) {
    for (my $line = 0; $line < $height; ++$line) {
      $cols[$col] .= substr($lines[$line], $col, 1);
    }
  }

  # Construct the key - numbers as Unicode code points
  my $str = "";
  foreach my $col (@cols) {
    $col =~ tr/.#/01/;
    $str .= sprintf("\\u{%04X}", oct("0b" . $col));
  }

  if (defined $table{$str}) {
    print STDERR sprintf(
      "Warning: Homoglyph collision U+%s '%c' vs. U+%s '%c' (dropping)\n",
      $char, hex($char),
      $table{$str}, hex($table{$str}),
        );
  } else{
    $table{$str} = $char;
    printf('ocr_table["%s"] = "\\u{%s}"', $str, $char);
    print("\n");
  }
}

# Finish generating the Lua file
print <<EOF;
return ocr_table
EOF
