#!/usr/bin/env bash

# Generate `out/buildinfo.inc` based off last commit and tag

set -e
cd "$(dirname "$0")/.."
source "bin/util.sh"

resfile="src/common/res/common.res.${lang}"

yyyy="$(git log -1 --format="%ad" --date=format:%Y)"
yy="$(git log -1 --format="%ad" --date=format:%y)"
mm="$(git log -1 --format="%ad" --date=format:%m)"
dd="$(git log -1 --format="%ad" --date=format:%d)"

month="$(egrep "\bres_string_month_name_${mm}\b" "$resfile" | cut -d'"' -f2)"
order="$(egrep "\bres_const_date_order\b" "$resfile" | cut -d' ' -f3)"
if [ "$order" = "0" ]; then
    date="$month $dd, $yyyy"
else
    date="$dd $month $yyyy"
fi

if [ "$supports_lowercase" != "1" ]; then
  vsuffix="$(echo "$vsuffix" | tr 'a-z' 'A-Z')"
fi

OUTDIR="out"

# Generate tmp file
cat > $OUTDIR/buildinfo.inc.tmp  <<EOF
.define kBuildDate "$date"
kBuildYYYY = $yyyy
kBuildYY   = $yy
kBuildMM   = $mm
kBuildDD   = $dd
.define kDeskTopVersionSuffix "$vsuffix"
EOF

# Only generate real file if it doesn't exist or changed
if [ -r $OUTDIR/buildinfo.inc ]; then
  cmp --silent $OUTDIR/buildinfo.inc.tmp $OUTDIR/buildinfo.inc || \
    mv -f $OUTDIR/buildinfo.inc.tmp $OUTDIR/buildinfo.inc
else
  mv -f $OUTDIR/buildinfo.inc.tmp $OUTDIR/buildinfo.inc
fi
