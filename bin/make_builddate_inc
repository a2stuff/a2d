#!/usr/bin/env bash

# Generate `out/date.inc` based off last commit

set -e
cd "$(dirname "$0")/.."

lang="$(egrep 'define kBuildLang' src/config.inc | cut -d'"' -f2)"

yyyy="$(git log -1 --format="%ad" --date=format:%Y)"
yy="$(git log -1 --format="%ad" --date=format:%y)"
mm="$(git log -1 --format="%ad" --date=format:%m)"
dd="$(git log -1 --format="%ad" --date=format:%d)"

month=$(egrep "\bres_string_month_name_${mm}\b" "src/common/res/common.res.${lang}" | cut -d'"' -f2)
order=$(egrep "\bres_const_date_order\b" "src/common/res/common.res.${lang}" | cut -d' ' -f3)

if [ "$order" = "0" ]; then
    date="$month $dd, $yyyy"
else
    date="$dd $month $yyyy"
fi

OUTDIR="out"

# Generate tmp file
cat > $OUTDIR/builddate.inc.tmp  <<EOF
.define kBuildDate "$date"
kBuildYYYY = $yyyy
kBuildYY   = $yy
kBuildMM   = $mm
kBuildDD   = $dd
EOF

# Only generate real file if it doesn't exist or changed
if [ -r $OUTDIR/builddate.inc ]; then
  cmp --silent $OUTDIR/builddate.inc.tmp $OUTDIR/builddate.inc || \
    mv -f $OUTDIR/builddate.inc.tmp $OUTDIR/builddate.inc
else
  mv -f $OUTDIR/builddate.inc.tmp $OUTDIR/builddate.inc
fi
