#!/usr/bin/env bash

# Syntax:
#
# bin/mametest [options] tests/SCRIPTNAME.lua
#
# Options
#
#    --only NAME         Run only the named test step
#    --visible           Don't run headless (i.e. do present video)
#    --audible           Don't run silent (i.e. do present audio)
#    --nosnaps           Don't show snapshots once tests are complete
#    --console           Don't run script, show console instead

# --------------------------------------------------

set -e
#set -x

cd "$(dirname "$0")/.."

# --------------------------------------------------
# Parse command line

TEST_NAME=""
VISIBLE=""
AUDIBLE=""
SNAPS=true
CONSOLE=""

for arg in "$@"; do
  case $1 in
    --only)      shift; TEST_NAME="$1"; shift ;;
    --visible)   shift; VISIBLE=true ;;
    --audible)   shift; AUDIBLE=true ;;
    --nosnaps)   shift; SNAPS="" ;;
    --console)   shift; CONSOLE=true ;;
    *)           SCRIPT="$(realpath "$1")"; shift; break ;;
  esac
done

if [ $# -gt 0 ]; then
  echo "Unexpected argument(s): $@" 1>&2
  exit 1
fi

# --------------------------------------------------

SCRIPTDIR="$(dirname "$SCRIPT")"
TMPDIR=/tmp/mametest
mkdir -p $TMPDIR/disks

# --------------------------------------------------
# Prepare snapshots dir

SNAPDIR=$TMPDIR/snaps
mkdir -p $SNAPDIR
if [ -e "$SNAPDIR/$MODEL" ]; then
  rm -r $SNAPDIR/$MODEL
fi

# --------------------------------------------------
# Configuration

MODEL="apple2ee"
MODELARGS="-sl1 ramfactor -sl2 mouse -sl7 scsi -aux rw3"
DISKARGS="-hard1 out/A2DeskTop-1.6-alpha0-en_800k.2mg"
RESOLUTION="560x384"

CONFIG="$(cat "$SCRIPT" | sed -n '/BEGINCONFIG/,/ENDCONFIG/p' | egrep -v 'BEGINCONFIG|ENDCONFIG' || true)"
if [ -n "$CONFIG" ]; then
  eval "$CONFIG"
fi

# --------------------------------------------------
# Disk handling

NEWDISKARGS=""
while read -r arg disk; do
  target="$TMPDIR/disks/${arg#?}"
  cp "$disk" "$target"
  NEWDISKARGS="$NEWDISKARGS $arg $target"
done < <(echo $DISKARGS | xargs -n 2)
DISKARGS="$NEWDISKARGS"

# --------------------------------------------------
# Run MAME

MAMEDIR=~/Library/Application\ Support/Ample/
MAMEEXE=~/Desktop/Ample.app/Contents/MacOS/mame64

OUTPUTARGS=""
if [ -z "$VISIBLE" ]; then
  export SDL_VIDEODRIVER=dummy
  OUTPUTARGS="$OUTPUTARGS -video none"
fi
if [ -z "$AUDIBLE" ]; then
  export SDL_AUDIODRIVER=dummy
  OUTPUTARGS="$OUTPUTARGS -sound none"
fi

if [ "$CONSOLE" ]; then
  SCRIPTARGS="-console"
else
  TIMEOUT=999
  SCRIPTARGS="-seconds_to_run $TIMEOUT -autoboot_script $SCRIPT"
fi

export LUA_PATH="$SCRIPTDIR/?.lua"
export TEST_NAME

pushd "$MAMEDIR" > /dev/null
"$MAMEEXE" \
  -skip_gameinfo -nosamples \
  -window -nomax -resolution $RESOLUTION -nounevenstretch \
  -mouse \
  -snapshot_directory "$SNAPDIR" -snapsize $RESOLUTION \
  $OUTPUTARGS \
  $MODEL $MODELARGS $DISKARGS \
  -nothrottle -nosleep \
  $SCRIPTARGS

popd > /dev/null

# --------------------------------------------------
# Show snapshots

if [ "$SNAPS" ]; then
  if ls $SNAPDIR/$MODEL/* >/dev/null 2>/dev/null; then
    open $SNAPDIR/$MODEL/*
  fi
fi
