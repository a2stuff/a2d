#!/usr/bin/env bash

# Syntax:
#
# bin/mametest [options] tests/SCRIPTNAME.lua
#
# Options
#
#    --only NAME         Run only the named test step
#    --visible           Don't run headless (i.e. do present video)
#    --audible           Don't run silent (i.e. do present audio)
#    --nosnaps           Don't show snapshots once tests are complete
#    --console           Don't run script, show console instead
#    --slow              Don't run emulation unthrottled

# --------------------------------------------------

set -e
#set -x

cd "$(dirname "$0")/.."

# --------------------------------------------------
# Parse command line

TEST_NAME=""
VISIBLE=""
AUDIBLE=""
SNAPS=true
CONSOLE=""
SLOW=""

for arg in "$@"; do
  case $1 in
    --only)      shift; TEST_NAME="$1"; shift ;;
    --visible)   shift; VISIBLE=true ;;
    --audible)   shift; AUDIBLE=true ;;
    --nosnaps)   shift; SNAPS="" ;;
    --console)   shift; CONSOLE=true ;;
    --slow)      shift; SLOW=true ;;
    *)           SCRIPT="$(realpath "$1")"; shift; break ;;
  esac
done

if [ $# -gt 0 ]; then
  echo "Unexpected argument(s): $@" 1>&2
  exit 1
fi

# --------------------------------------------------

BASEDIR="$(pwd)"
SCRIPTDIR="$(dirname "$SCRIPT")"
TMPDIR=/tmp/mametest
mkdir -p "$TMPDIR"/disks

NVRAMDIR="$TMPDIR"/nvram
mkdir -p "$NVRAMDIR"
rm -rf "$NVRAMDIR"/*

# --------------------------------------------------
# Configuration

VERSION="1.6-alpha0"
HARDIMG="out/A2DeskTop-$VERSION-en_800k.2mg"
FLOP1IMG="out/A2DeskTop-1.6-alpha0-en_140k_disk1.po"
FLOP2IMG="out/A2DeskTop-1.6-alpha0-en_140k_disk2.po"

MODEL="apple2ee"
MODELARGS="-sl1 ramfactor -sl2 mouse -sl7 scsi -aux rw3"
DISKARGS="-hard1 $HARDIMG"
RESOLUTION="560x384"

CONFIG="$(cat "$SCRIPT" | sed -n '/BEGINCONFIG/,/ENDCONFIG/p' | egrep -v 'BEGINCONFIG|ENDCONFIG' || true)"
if [ -n "$CONFIG" ]; then
  eval "$CONFIG"
fi

# --------------------------------------------------
# Disk handling

NEWDISKARGS=""
while read -r arg disk; do
  target="$TMPDIR/disks/${arg#?}"
  cp "$disk" "$target"
  NEWDISKARGS="$NEWDISKARGS $arg $target"
done < <(echo $DISKARGS | xargs -n 2)
DISKARGS="$NEWDISKARGS"

# --------------------------------------------------
# Prepare snapshots dir

SNAPDIR="$TMPDIR"/snaps
mkdir -p "$SNAPDIR/$MODEL"
rm -rf "$SNAPDIR/$MODEL/"*

# --------------------------------------------------
# Run MAME

MAMEDIR=~/Library/Application\ Support/Ample/
MAMEEXE=~/Desktop/Ample.app/Contents/MacOS/mame64

OUTPUTARGS=""
if [ -z "$VISIBLE" ]; then
  export SDL_VIDEODRIVER=dummy
  OUTPUTARGS="$OUTPUTARGS -video none"
fi
if [ -z "$AUDIBLE" ]; then
  export SDL_AUDIODRIVER=dummy
  OUTPUTARGS="$OUTPUTARGS -sound none"
fi

if [ "$CONSOLE" ]; then
  SCRIPTARGS="-console"
else
  TIMEOUT=9999
  SCRIPTARGS="-seconds_to_run $TIMEOUT -autoboot_script $BASEDIR/tests/lib/autoboot.lua"
  export LUA_SCRIPT="$SCRIPT"
fi


if [ "$SLOW" ]; then
  THROTTLE=""
else
  THROTTLE="-nothrottle"
fi

export LUA_PATH="$BASEDIR/tests/lib/?.lua;$SCRIPTDIR/?.lua"
export TEST_NAME

pushd "$MAMEDIR" > /dev/null
"$MAMEEXE" \
  -skip_gameinfo -nosamples \
  -window -nomax -resolution "$RESOLUTION" -nounevenstretch \
  -mouse \
  -nvram_directory "$NVRAMDIR" \
  -snapshot_directory "$SNAPDIR" -snapsize "$RESOLUTION" \
  $OUTPUTARGS \
  "$MODEL" $MODELARGS $DISKARGS \
  $THROTTLE -nosleep \
  $SCRIPTARGS \
  2>&1 | egrep -v "Secure coding is automatically enabled"

popd > /dev/null

# --------------------------------------------------
# Show snapshots

if [ "$SNAPS" ]; then
  if ls "$SNAPDIR/$MODEL"/* >/dev/null 2>/dev/null; then
    open "$SNAPDIR/$MODEL/"*
  fi
fi
