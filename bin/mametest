#!/usr/bin/env bash

# Syntax:
#
# bin/mametest [options] tests/SCRIPTNAME.lua
#
# Options
#
#    --only PATTERN      Run only matching named test steps (wildcards * and ?, | too)
#    --skip N            Skip the first N tests
#    --count N           Run at most N tests
#    --visible           Don't run headless (i.e. do present video)
#    --audible           Don't run silent (i.e. do present audio)
#    --nosnaps           Don't show snapshots once tests are complete
#    --console           Don't run script, show console instead
#    --slow              Don't run emulation unthrottled
#    --debug             Run with MAME's debugger
#    --listmedia         Print out MAME's list of drive options
#    --listslots         Print out MAME's list of slot options
#
# MAMEDIR must be set to the path containing roms/ etc
# MAMEEXE must be set to the path to the mame64 binary

# --------------------------------------------------

set -e
#set -x

cd "$(dirname "$0")/.."
source "bin/util.sh"

# --------------------------------------------------
# Parse command line

TEST_NAME=""
SKIP_COUNT=""
RUN_COUNT=""
VISIBLE=""
AUDIBLE=""
SNAPS=true
CONSOLE=""
SLOW=""
MAMEFLAGS=""

for arg in "$@"; do
  case $1 in
    --only)      shift; TEST_NAME="$1"; shift ;;
    --only=*)    TEST_NAME="${1#--only=}"; shift ;;
    --skip)      shift; SKIP_COUNT="$1"; shift ;;
    --skip=*)    SKIP_COUNT="${1#--skip=}"; shift ;;
    --count)     shift; RUN_COUNT="$1"; shift ;;
    --count=*)   RUN_COUNT="${1#--count=}"; shift ;;
    --visible)   shift; VISIBLE=true ;;
    --audible)   shift; AUDIBLE=true ;;
    --nosnaps)   shift; SNAPS="" ;;
    --console)   shift; CONSOLE=true ;;
    --slow)      shift; SLOW=true ;;
    --debug)     shift; MAMEFLAGS="$MAMEFLAGS -debug" ;;
    --listmedia) shift; MAMEFLAGS="$MAMEFLAGS -listmedia" ;;
    --listslots) shift; MAMEFLAGS="$MAMEFLAGS -listslots" ;;
    *)           SCRIPT="$(realpath "$1")"; shift; break ;;
  esac
done

if [ $# -gt 0 ]; then
  echo "Unexpected argument(s): $@" 1>&2
  exit 1
fi

# Validate environment

if [ ! -x "$MAMEEXE" ]; then
  echo "MAMEEXE is not an executable" 1>&2
  exit 1
fi
if [ ! -d "$MAMEDIR" ]; then
  echo "MAMEDIR is not a directory" 1>&2
  exit 1
fi

# --------------------------------------------------

BASEDIR="$(pwd)"
SCRIPTDIR="$(dirname "$SCRIPT")"
TMPDIR=/tmp/mametest

DISKSDIR="$TMPDIR"/disks
mkdir -p "$DISKSDIR"

NVRAMDIR="$TMPDIR"/nvram
mkdir -p "$NVRAMDIR"
rm -rf "$NVRAMDIR"/*

# --------------------------------------------------
# Configuration

HARDIMG="../../out/A2DeskTop-${version}_800k.2mg"
FLOP1IMG="../../out/A2DeskTop-${version}_140k_disk1.po"
FLOP2IMG="../../out/A2DeskTop-${version}_140k_disk2.po"

if [ ! -f "tests/images/$HARDIMG" ]; then
  make package
fi

MODEL="apple2ee"
MODELARGS="-sl2 mouse -sl7 cffa2"
DISKARGS="-hard1 $HARDIMG"
RESOLUTION="560x384"
WAITFORDESKTOP="true"
CHECKAUXMEMORY="true"

CONFIG="$(cat "$SCRIPT" | sed -n '/BEGINCONFIG/,/ENDCONFIG/p' | grep -E -v 'BEGINCONFIG|ENDCONFIG' || true)"
if [ -n "$CONFIG" ]; then
  eval "$CONFIG"
fi

# --------------------------------------------------
# Disk handling

NEWDISKARGS=""
while read -r arg disk; do
  target="$DISKSDIR/${arg#?}"
  cp "tests/images/$disk" "$target"
  NEWDISKARGS="$NEWDISKARGS $arg $target"
done < <(echo $DISKARGS | xargs -n 2)
DISKARGS="$NEWDISKARGS"

export UNFORMATTED_IMG="$DISKSDIR/unformatted.2mg"
cp "tests/images/unformatted.2mg" "$UNFORMATTED_IMG"

# --------------------------------------------------
# VEDrive

# From https://github.com/bobbimanners/ProDOS-Utils/

VESERVER="../ProDOS-Utils/veserver.py"
VESERVERARGS=""
if [ -n "$VEDISK1" ]; then
  ext="${VEDISK1##*.}"
  target="$DISKSDIR/vdisk1.${ext}"
  cp "$VEDISK1" "$target"
  VESERVERARGS="$VESERVERARGS --disk1=$target"
fi
if [ -n "$VEDISK2" ]; then
  ext="${VEDISK2##*.}"
  target="$DISKSDIR/vdisk2.${ext}"
  cp "$VEDISK2" "$target"
  VESERVERARGS="$VESERVERARGS --disk2=$target"
fi
if [ -n "$VESERVERARGS" ]; then
  if [ ! -x "$VESERVER" ]; then
    echo "$VESERVER not found!" 1>&2
    exit 1
  fi
  ../ProDOS-Utils/veserver.py $VESERVERARGS >/dev/null &
  VESERVER_PID=$!
  trap "kill $VESERVER_PID" EXIT
fi

# --------------------------------------------------
# Symbols

DESKTOP_SYMBOLS=""
for sym in selected_icon_count selected_icon_list icon_entries current_window; do
  addr="$(grep -E $sym: out/desktop.list | cut -d' ' -f1)"
  DESKTOP_SYMBOLS="${DESKTOP_SYMBOLS} ${sym}=${addr}"
done
export DESKTOP_SYMBOLS
SELECTOR_SYMBOLS=""
for sym in current_window; do
  addr="$(grep -E $sym: out/selector.list | cut -d' ' -f1)"
  SELECTOR_SYMBOLS="${SELECTOR_SYMBOLS} ${sym}=${addr}"
done
export SELECTOR_SYMBOLS

# --------------------------------------------------
# Prepare snapshots dir

SNAPDIR="$TMPDIR"/snaps
mkdir -p "$SNAPDIR/$MODEL"
rm -rf "$SNAPDIR/$MODEL/"*

# --------------------------------------------------
# Prepare configs dir

CFGDIR="$TMPDIR"/cfg
mkdir -p "$CFGDIR"

cp "${BASEDIR}/tests/cfg/${MODEL}.cfg" "$CFGDIR"

# --------------------------------------------------
# Run MAME

OUTPUTARGS=""
if [ -z "$VISIBLE" ]; then
  export SDL_VIDEODRIVER=dummy
  OUTPUTARGS="$OUTPUTARGS -video none"
fi
if [ -z "$AUDIBLE" ]; then
  export SDL_AUDIODRIVER=dummy
  OUTPUTARGS="$OUTPUTARGS -sound none"
fi

if [ "$CONSOLE" ]; then
  SCRIPTARGS="-console"
else
  TIMEOUT=$(( 60 * 60 * 4 )) # 4 hours, simulated
  SCRIPTARGS="-seconds_to_run $TIMEOUT -autoboot_script $BASEDIR/tests/lib/autoboot.lua"
  export LUA_SCRIPT="$SCRIPT"
fi

if [ "$SLOW" ]; then
  THROTTLE=""
else
  THROTTLE="-nothrottle -nosleep"
fi

# Imported by the autoboot script
export LUA_PATH="$BASEDIR/tests/lib/?.lua;$SCRIPTDIR/?.lua"
export TEST_NAME
export SKIP_COUNT
export RUN_COUNT
export WAITFORDESKTOP
export CHECKAUXMEMORY

export COLOR_RED="$(tput setaf 1)"
export COLOR_RESET="$(tput sgr0)"

pushd "$MAMEDIR" > /dev/null
exec 5>&1 # duplicate stdout filehandle
output=$(
  # eval here to allow configs to specify empty variables e.g. -sl6 ''
  time eval "'$MAMEEXE' \
    -skip_gameinfo -nosamples \
    -window -nomax -resolution '$RESOLUTION' -nounevenstretch \
    -mouse \
    -cfg_directory '$CFGDIR' \
    -nvram_directory '$NVRAMDIR' \
    -snapshot_directory '$SNAPDIR' -snapsize '$RESOLUTION' \
    $OUTPUTARGS \
    '$MODEL' $MODELARGS $DISKARGS \
    $THROTTLE \
    $MAMEFLAGS \
    $SCRIPTARGS" \
       2> >(IFS='' ; while read line; do echo "${COLOR_RED}${line}${COLOR_RESET}" >&1; done) | \
    grep -E --line-buffered -v "Secure coding is automatically enabled" | \
    tee /dev/fd/5
      )
popd > /dev/null

# --------------------------------------------------
# Stash output

echo "$output" > "$TMPDIR/output.txt"

relpath="${SCRIPT#$(pwd)/tests/}"
resdir="$TMPDIR/results/$(dirname "$relpath")"
mkdir -p "$resdir"

zipfile="${resdir}/$(basename "$SCRIPT" .lua).zip"
rm -f "$zipfile"
zip --quiet --junk-paths "$zipfile" "$TMPDIR/output.txt"

# --------------------------------------------------
# Show snapshots

# Parse output to determine snapshot names
snapname=()
while IFS= read -r line ; do
  pattern='\[snap: ([0-9]+)\] (.*)'
  if [[ $line =~ $pattern ]]; then
    snapname["10#${BASH_REMATCH[1]}"]="${BASH_REMATCH[2]//\//-}"
  fi
done <<< "$output"

if ls "$SNAPDIR/$MODEL/"????.png >/dev/null 2>/dev/null; then
  # Rename files to include snapshot names
  for file in "$SNAPDIR/$MODEL"/????.png; do
    dir="$(dirname "$file")"
    num="$(basename "$file" .png)"
    name="${snapname[10#$num]}"
    if [ -n "$name" ]; then
      mv "${dir}/${num}.png" "${dir}/${num} - ${name}.png"
    fi
  done

  # Add snapshots to results
  zip --quiet --junk-paths "$zipfile" "$SNAPDIR/$MODEL/"*.png

  # Optionally show snapshots
  if [ "$SNAPS" ]; then
    open "$SNAPDIR/$MODEL/"*.png
  fi
fi

echo "Wrote results to ${zipfile}"
