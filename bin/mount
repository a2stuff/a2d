#!/usr/bin/env bash

# Run this from the top level directory

set -e
source "bin/util.sh"

MOUNT_DIR="mount"

mkdir -p $MOUNT_DIR/test || (cecho red "permission denied"; exit 1)
rmdir $MOUNT_DIR/test

# ============================================================
# Implementations for manifest operations

add_file() {
    local disposition="$1"
    local src_file="$2"
    local folder="$3"
    local dst_file="$4"
    local suffix="$5"

    local dst_dir="$MOUNT_DIR"
    if [ "$folder" != "" ]; then
        dst_dir="$MOUNT_DIR/$folder"
    fi

    local type="${suffix:0:2}"
    local auxh="${suffix:2:2}"
    local auxl="${suffix:4:2}"
    local dst="$dst_file.\$$type"
    cp "$src_file" "$dst_dir/$dst" \
	&& xattr -wx prodos.AuxType "$auxl $auxh" "$dst_dir/$dst" \
        && (cecho green "- $dst_dir/$dst" ) \
        || (cecho red "failed to mount $dst_dir/$dst" ; return 1)

    if [ "$suffix" = "040000" ]; then
        perl -p -i -e 's/\r?\n/\r/g' "$dst_dir/$dst" # Ensure Apple line endings
    fi
}

create_folder() {
    local disposition="$1"
    local path="$2"

    mkdir -p "$MOUNT_DIR/$path"
}

# ============================================================

cecho yellow "Copying files to $MOUNT_DIR/"

manifest="$(bin/manifest $@)"
eval "$manifest"
